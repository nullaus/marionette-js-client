<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/marionette/drivers/tcp-sync.js - Marionette JS Client</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.7.0/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.7.0/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
          <h1>
            Marionette JS Client
          </h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.7.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Marionette.Actions.html">Marionette.Actions</a></li>
            
                <li><a href="../classes/Marionette.Client.html">Marionette.Client</a></li>
            
                <li><a href="../classes/Marionette.CommandStream.html">Marionette.CommandStream</a></li>
            
                <li><a href="../classes/Marionette.Drivers.Abstract.html">Marionette.Drivers.Abstract</a></li>
            
                <li><a href="../classes/Marionette.Drivers.MozTcp.html">Marionette.Drivers.MozTcp</a></li>
            
                <li><a href="../classes/Marionette.Drivers.Tcp.html">Marionette.Drivers.Tcp</a></li>
            
                <li><a href="../classes/Marionette.Element.html">Marionette.Element</a></li>
            
                <li><a href="../classes/Marionette.MultiActions.html">Marionette.MultiActions</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib/marionette/drivers/tcp-sync.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var wire = require(&#x27;json-wire-protocol&#x27;);
var debug = require(&#x27;debug&#x27;)(&#x27;marionette:tcp-sync&#x27;);
var sockittome = require(&#x27;sockit-to-me&#x27;);
var DEFAULT_HOST = &#x27;localhost&#x27;;
var DEFAULT_PORT = 2828;
var SOCKET_TIMEOUT_EXTRA = 500;

function TcpSync(options) {
  if (!options) {
    options = {};
  }

  if (&#x27;port&#x27; in options) {
    this.port = options.port;
  }
  if (&#x27;host&#x27; in options) {
    this.host = options.host;
  }
  if (&#x27;connectionTimeout&#x27; in options) {
    this.connectionTimeout = options.connectionTimeout;
  }

  this.sockit = new sockittome.Sockit();
  this.sockit.setPollTimeout(this.connectionTimeout + SOCKET_TIMEOUT_EXTRA);
};

TcpSync.prototype.isSync = true;
TcpSync.prototype.host = DEFAULT_HOST;
TcpSync.prototype.port = DEFAULT_PORT;
TcpSync.prototype.connectionTimeout = 2000;
TcpSync.prototype.retryInterval = 300;

TcpSync.prototype.setScriptTimeout = function(timeout) {
  this.sockit.setPollTimeout(timeout + SOCKET_TIMEOUT_EXTRA);
};

/**
 * Utility to wait for the marionette socket to be ready.
 *
 * @method waitForSocket
 * @param {Object} [options] for timeout.
 * @param {Number} [options.interval] time between running test.
 * @param {Number} [options.timeout] maximum wallclock time before
 *   failing test.
 * @param {Function} [callback] callback.
 */
TcpSync.prototype.waitForSocket = function(options, callback) {
  // the logic is lifted from http://dxr.mozilla.org/mozilla-central/source/testing/marionette/client/marionette/marionette.py#562

  if (typeof(options) === &#x27;function&#x27;) {
    callback = options;
    options = null;
  }

  options = options || {};
  var interval = options.interval || 0;
  var timeout = options.timeout || 30000;
  var socketTimeout = 1000;

  var sockit = new sockittome.Sockit();
  var start = Date.now();
  var self = this;

  // Use sockittome&#x27;s built in polling timeout during calls to connect
  // to avoid socket misuse.
  sockit.setPollTimeout(socketTimeout);
  var socketConfig = { host: this.host, port: this.port };

  function probeSocket() {
    try {
      debug(&#x27;probing socket&#x27;);
      sockit.connect(socketConfig);

      var s = sockit.read(16).toString();
      sockit.close();
      if (s.indexOf(&quot;:&quot;) != -1) {
        callback();
        return;
      }
    }
    catch(e) {
      debug(&#x27;exception when probing socket&#x27;, e.message);
      // Above read _may_ fail so it is important to close the socket...
      sockit.close();
    }
    // timeout. Abort.
    if ((Date.now() - start) &gt; timeout) {
      console.error(&#x27;timeout connecting to b2g.&#x27;);
      return;
    }
    // interval delay for the next iteration.
    setTimeout(probeSocket.bind(self), interval);
  };

  probeSocket();
}

TcpSync.prototype.connect = function(callback) {

  this.waitForSocket(function _connect() {
    try {
      this.sockit.connect({ host: this.host, port: this.port });
    } catch(err) {
      if (Date.now() - this._beginConnect &gt;= this.connectionTimeout) {
        callback(err);
      }
      setTimeout(_connect.bind(this, callback), this.retryInterval);
      return;
    }

    if (!this._beginConnect) {
      this._beginConnect = Date.now();
    }

    // Ensure this method&#x27;s resolution is asynchronous in all cases
    process.nextTick(function() {
      debug(&#x27;socket connected&#x27;);
      delete this._beginConnect;

      this._readResponse();

      callback();
    }.bind(this));
  }.bind(this));
};

TcpSync.prototype.defaultCallback = function(err, result) {
  if (err) {
    throw err;
  }
  return result;
};

// Following the json-wire-protocol implementation, read one byte at a time
// until the &#x27;separator&#x27; character is received. The data preceding the
// delimiter describes the length of the JSON string.
TcpSync.prototype._readResponse = function() {
  var stream = new wire.Stream();
  var char, data, error;

  stream.on(&#x27;data&#x27;, function(parsed) {
    debug(&#x27;read&#x27;, parsed);
    data = parsed;
  });
  stream.on(&#x27;error&#x27;, function(err) {
    error = err;
  });

  while (!data &amp;&amp; !error) {
    stream.write(this.sockit.read(1));
  }

  if (error) {
    throw error;
  }

  return data;
};

TcpSync.prototype.send = function(command, callback) {
  debug(&#x27;write&#x27;, command);
  this.sockit.write(wire.stringify(command));
  return callback(this._readResponse());
};

TcpSync.prototype.close = function() {
  this.sockit.close();
};

module.exports = TcpSync;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
